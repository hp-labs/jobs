<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bà chủ – Quản lý lương Phúc</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{
  --primary:#e91e63;
  --gradient:linear-gradient(135deg,#ff9a9e,#fad0c4);
  --card:rgba(255,255,255,0.98);
  --shadow:0 20px 40px rgba(0,0,0,0.2);
}
*{box-sizing:border-box}
body{margin:0;font-family:'Kanit',sans-serif;background:var(--gradient);color:#333;overflow-x:hidden;}
.menu-btn{position:fixed;top:20px;left:20px;z-index:1000;background:white;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;box-shadow:0 8px 20px rgba(0,0,0,0.3);cursor:pointer;transition:.3s;}
.menu-btn:hover{transform:scale(1.05);}
.sidebar{position:fixed;top:0;left:-300px;width:300px;height:100vh;background:rgba(233,30,99,0.95);padding:90px 20px 20px;transition:left .35s;z-index:999;box-shadow:6px 0 30px rgba(0,0,0,0.25);backdrop-filter:blur(8px);}
.sidebar.active{left:0;}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);opacity:0;visibility:hidden;transition:.25s;z-index:998;}
.overlay.active{opacity:1;visibility:visible;}
.menu-item{padding:16px 18px;color:white;font-size:1.1rem;border-radius:10px;margin-bottom:12px;cursor:pointer;display:flex;align-items:center;gap:10px;}
.menu-item:hover,.menu-item.active{background:rgba(255,255,255,0.12);transform:translateX(8px);}
.menu-item i{width:22px;text-align:center;}
.main-content{padding:20px;max-width:880px;margin:0 auto;min-height:100vh;}
.card{background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:26px;margin-top:90px;transition:.25s;}
.hidden{display:none;}
button{background:var(--primary);color:white;border:none;padding:12px;border-radius:12px;cursor:pointer;font-size:1rem;}
.h1{color:var(--primary);text-align:center;margin:0 0 12px 0}
.shift-label {
    font-weight: bold;           /* chữ đậm */
    font-size: 1.1em;            /* to hơn bình thường */
    color: #ffcc00;              /* vàng nổi bật */
    background: rgba(0, 0, 0, 0.1); /* nền nhẹ để chữ nổi */
    padding: 4px 8px;
    border-radius: 6px;          /* bo tròn nhẹ */
    display: inline-block;       /* tránh bị dàn hàng dài */
    box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* tạo cảm giác 3D nhẹ */
    transition: transform 0.2s ease;
  }
  
  .shift-label:hover {
    transform: scale(1.05);       /* hover nhấc lên nhẹ */
  }

.schedule-item {
    font-weight: bold;
    font-size: 1.2em;               /* to hơn bình thường */
    color: #7b3131;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    padding: 12px 16px;
    margin: 8px 0;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    justify-content: space-between;
}


  
  .schedule-item:hover {
    transform: scale(1.03); /* hover nhấn nổi nhẹ */
  }
  
/* history / items */
.history-item {
    background: linear-gradient(145deg, #ff9a9e, #fad0c4); /* gradient 3D */
    border-radius: 16px;
    padding: 15px 20px;
    margin-bottom: 12px;
    color: #fff;
    font-weight: 500;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25), 0 4px 6px rgba(0,0,0,0.15);
    transform: perspective(600px) rotateX(0deg);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  /* hover nổi bật hơn */
  .history-item:hover {
    transform: perspective(600px) rotateX(5deg) translateY(-5px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.35), 0 6px 10px rgba(0,0,0,0.2);
  }
  
  
  /* hover nổi bật hơn */
  .history-item:hover {
    transform: perspective(600px) rotateX(5deg) translateY(-5px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.35), 0 6px 10px rgba(0,0,0,0.2);
  }
  
  .history-actions .action-btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 36px; height: 36px;
    margin-left: 8px;
    border-radius: 50%;
    cursor: pointer;
    color: #fff;
    background: linear-gradient(135deg, #ff758c, #ff7eb3);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .history-actions .action-btn:hover {
    transform: translateY(-3px) scale(1.1);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  }
  
/* pay list */
.pay-controls{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
#pay-list{margin-top:12px;}
.pay-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:#fff;margin-bottom:10px;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
.pay-item.paid{background:#f1f8f3;color:#2e7d32;}
.pay-item .meta{flex:1}

/* big total button */
#total-pay-btn{display:inline-block;padding:14px 18px;border-radius:12px;background:#ff4081;color:#fff;font-weight:700;border:none;font-size:1.05rem;cursor:pointer;box-shadow:0 10px 30px rgba(255,64,129,0.25)}
#total-pay-text{display:inline-block;padding:12px 16px;border-radius:10px;background:rgba(0,0,0,0.04);margin-left:10px}

/* popup QR inside pay page */
#qr-popup{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;z-index:2000;}
#qr-popup.active{display:flex;}
#qr-popup .backdrop{position:absolute;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);}
#qr-popup .card-qr{position:relative;z-index:2;width:min(520px,92%);background:#fff;border-radius:14px;padding:20px;box-shadow:0 30px 80px rgba(0,0,0,0.35);text-align:center;}
#qr-popup img{max-width:100%;height:auto;border-radius:8px;margin:12px 0}
#qr-popup .close-btn{position:absolute;right:12px;top:12px;background:#eee;border-radius:8px;padding:6px 8px;cursor:pointer}
#scheduleForm {
    display: none;
}

/* small responsive */
@media (max-width:720px){
  .sidebar{width:260px}
  .menu-btn{width:52px;height:52px}
  .main-content{padding:14px}
}
.schedule-item {
    background: white;
    padding: 20px;
    border-radius: 20px;
    margin: 15px 0;
    box-shadow: 0 10px 30px rgba(233,30,99,0.2);
    border-left: 6px solid #e91e63;
    transition: all 0.3s;
  }
  .schedule-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(233,30,99,0.3);
  }
</style>
</head>
<body>
  <div class="menu-btn" id="menuBtn">☰</div>
  <div class="overlay" id="overlay"></div>

  <div class="sidebar" id="sidebar">
    <div class="menu-item active" data-page="history"><i class="fas fa-history"></i> Lịch sử</div>
    <div class="menu-item" data-page="add-attendance"><i class="fas fa-calendar-plus"></i> Thêm ngày làm</div>
    <div class="menu-item" data-page="pay"><i class="fas fa-credit-card"></i> Thanh toán lương</div>
    <div class="menu-item" data-page="schedule"><i class="fas fa-calendar-day"></i> Lịch làm tuần tới</div>
 
    <div class="menu-item" id="logoutBtn" style="margin-top:auto;background:rgba(0,0,0,0.12);"><i class="fas fa-sign-out-alt"></i> Đăng xuất</div>
  </div>

  <div class="main-content">
    <h2 class="h1">Quản lý lương</h2>

    <!-- HISTORY -->
    <div id="history-page" class="card">
      <h3 style="margin:0 0 12px 0">Lịch sử</h3>
      <div id="history-list">Đang tải...</div>
    </div>
    
    <!-- ADD ATTENDANCE -->
    <div id="add-attendance-page" class="card hidden">
      <h3 style="margin:0 0 12px 0;color:var(--primary)">Thêm ngày làm</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <input type="date" id="add-date" style="padding:10px;border-radius:8px;border:1px solid #ddd">
        <input type="time" id="add-time-in" style="padding:10px;border-radius:8px;border:1px solid #ddd">
        <input type="time" id="add-time-out" style="padding:10px;border-radius:8px;border:1px solid #ddd">
        <button id="add-attendance-btn">Thêm ngày làm</button>
      </div>
      <h4 style="margin-top:16px">Tất cả ngày làm</h4>
      <div id="add-attendance-list">Đang tải...</div>
    </div>

    <!-- Trang lịch làm việc -->
    <div id="schedule-page" class="card hidden">
      
      
      
        <h3 style="margin-top:30px;">Lịch làm</h3>
        <div id="schedule-list">Đang tải...</div>
      </div>
      
    <!-- PAY -->
    <div id="pay-page" class="card hidden">
      <h3 style="margin:0 0 12px 0">Thanh toán lương</h3>

      <div class="pay-controls">
        <button id="select-all-btn">Chọn tất cả chưa thanh toán</button>
        <button id="pay-now-btn" style="background:#3b82f6">Thanh toán (mở QR)</button>
        <button id="mark-paid-btn" style="background:#16a34a">Đánh dấu đã thanh toán</button>

        <div style="margin-left:auto;display:flex;align-items:center">
          <button id="total-pay-btn">Tổng: 0 đ</button>
        </div>
      </div>

      <div id="pay-list">Đang tải...</div>
    </div>
  </div>

  <!-- QR POPUP (nằm trong trang thanh toán, nhưng global in DOM) -->
  <div id="qr-popup" aria-hidden="true">
    <div class="backdrop" id="qr-backdrop"></div>
    <div class="card-qr" role="dialog" aria-modal="true">
      <div class="close-btn" id="qr-close">✕</div>
      <h3>Quét mã QR để chuyển khoản</h3>
      <!-- Placeholder QR: Phúc sẽ thay bằng link Google Drive sau -->
      <img id="qr-image" src="https://via.placeholder.com/420x420.png?text=QR+placeholder" alt="QR chuyển khoản (placeholder)">
      <p id="qr-selected-info" style="color:#555;margin:8px 0">Các mục đã chọn: <span id="qr-count">0</span></p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button id="qr-confirm" style="background:#16a34a">Xác nhận chuyển khoản</button>
        <button id="qr-cancel" style="background:#e11d48">Đóng</button>
      </div>
    </div>
  </div>

<script>
/* =========== Firebase init ============ */
const firebaseConfig={apiKey:"AIzaSyB3QQKW5kb9I3mZ4vr8lYcSBTEZZ1sAM8s",authDomain:"hplabs-jobs.firebaseapp.com",projectId:"hplabs-jobs",storageBucket:"hplabs-jobs.firebasestorage.app",messagingSenderId:"424963153110",appId:"1:424963153110:web:cb380d3dff8d5582dafd77",measurementId:"G-GGL0HW29KT"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const PHUC_EMAIL="nhp@gmail.com";

/* =========== Global helper (sửa / xóa) ========== */
// xóa record (global)
async function deleteAddRecord(id){
  if(!confirm("Xóa vĩnh viễn bản ghi này?")) return;
  await db.collection("attendance").doc(id).delete();
  alert("Đã xóa!");
}
const schedulePage = document.getElementById("schedule-page");
const scheduleDate = document.getElementById("schedule-date");
const scheduleShift = document.getElementById("schedule-shift");
const btnScheduleSave = document.getElementById("btn-schedule-save");
const scheduleList = document.getElementById("schedule-list");


async function loadSchedule() {
    scheduleList.innerHTML = "Đang tải dữ liệu...";
    db.collection("schedule").orderBy("date","asc")
      .onSnapshot(snap => {
        scheduleList.innerHTML = "";
        if(snap.empty){
          scheduleList.innerHTML = "<p style='text-align:center;color:#999;padding:20px;'>Chưa có lịch làm nào</p>";
          return;
        }
        snap.forEach(doc => {
          const d = doc.data();
          if(d.email !== PHUC_EMAIL && d.email !== auth.currentUser.email) return;  // Lọc theo email nếu cần
          const div = document.createElement("div");
          div.className = "history-item";  // Giữ class để giống giao diện code 2
          div.innerHTML = `
            <strong>${d.date.replace(/-/g,"/")}</strong> → ${d.shift}
          `;
          // Loại bỏ hoàn toàn history-actions (không có nút sửa/xóa)
          scheduleList.appendChild(div);
        });
      });
  }
  
  
loadSchedule();

// Menu chuyển trang
document.querySelectorAll(".menu-item").forEach(i=>{
    i.onclick = () => {
      document.querySelectorAll(".menu-item").forEach(x=>x.classList.remove("active")); 
      i.classList.add("active");
      checkinPage.classList.add("hidden"); 
      historyPage.classList.add("hidden");
      schedulePage.classList.add("hidden");
      if(i.dataset.page==="checkin") checkinPage.classList.remove("hidden");
      if(i.dataset.page==="history") {historyPage.classList.remove("hidden"); loadHistory();}
      if(i.dataset.page==="schedule") {schedulePage.classList.remove("hidden"); loadSchedule();}
      sidebar.classList.remove("active"); overlay.classList.remove("active");
    };
  });
  

// sửa record (global) — gỡ bản cũ, điền vào form
function editAddRecord(id,date,timeInVal,timeOutVal){
  if(!confirm("Bạn muốn sửa bản ghi này?")) return;
  document.getElementById("add-date").value = date;
  document.getElementById("add-time-in").value = timeInVal;
  document.getElementById("add-time-out").value = timeOutVal;
  // xóa bản cũ, user sẽ bấm Thêm để tạo lại
  db.collection("attendance").doc(id).delete().then(()=>alert("Đã xóa bản cũ — nhập lại và nhấn Thêm để lưu."));
}

/* =========== DOM ready ========== */
document.addEventListener("DOMContentLoaded", ()=>{

  // auth check (keeps behavior from your app)
  auth.onAuthStateChanged(u=>{
    if(!u){
      // nếu ko login chuyển về index
      // location.href = "index.html";
      // cho dev: nếu không login vẫn load (bỏ comment), hiện tại tạm ko chuyển
      console.log("Auth state: ", u);
    }
    loadAllData();
  });

  // gắn sự kiện lưu lịch làm



  // load lần đầu
  loadSchedule();

  /* layout controls */
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  document.getElementById("menuBtn").addEventListener("click", ()=>{sidebar.classList.toggle("active"); overlay.classList.toggle("active");});
  overlay.addEventListener("click", ()=>{sidebar.classList.remove("active"); overlay.classList.remove("active");});

  document.querySelectorAll(".menu-item").forEach(item=>{
    item.addEventListener("click", (e)=>{
      if(item.id==="logoutBtn"){ auth.signOut(); location.href="index.html"; return; }
      document.querySelectorAll(".menu-item").forEach(x=>x.classList.remove("active"));
      item.classList.add("active");
      document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
      const page = item.dataset.page;
      document.getElementById(page + "-page").classList.remove("hidden");
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
    });
  });

  /* ========== Add attendance form ========== */
  const addDate = document.getElementById("add-date");
  const addTimeIn = document.getElementById("add-time-in");
  const addTimeOut = document.getElementById("add-time-out");
  const addBtn = document.getElementById("add-attendance-btn");
  addDate.valueAsDate = new Date();

  addBtn.addEventListener("click", async ()=>{
    if(!addDate.value || !addTimeIn.value || !addTimeOut.value){ alert("Điền đầy đủ!"); return; }
    await db.collection("attendance").add({
      email: PHUC_EMAIL,
      date: addDate.value,
      timeIn: addTimeIn.value,
      timeOut: addTimeOut.value,
      paid: false,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    addTimeIn.value = addTimeOut.value = "";
    loadHistory(); loadAddAttendance(); loadPayList();
    alert("Thêm thành công!");
  });

  /* ========== Helpers ========== */
  function calcHours(inT, outT){
    const [h1,m1] = inT.split(":").map(Number);
    const [h2,m2] = outT.split(":").map(Number);
    let min = (h2*60+m2) - (h1*60+m1);
    if(min < 0) min += 1440;
    return (min/60).toFixed(2);
  }

  /* ========== HISTORY (hiển thị tất cả) ========== */
  function loadHistory(){
    const el = document.getElementById("history-list");
    el.innerHTML = "Đang tải...";
    db.collection("attendance").orderBy("date","desc").onSnapshot(snapshot=>{
      el.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        if(d.email !== PHUC_EMAIL) return;
        const hours = calcHours(d.timeIn, d.timeOut);
        const wrapper = document.createElement("div");
        wrapper.className = "history-item" + (d.paid ? " paid" : "");
        wrapper.innerHTML = `
          <div class="history-left">
            <div style="font-weight:700">${d.date.replace(/-/g,'/')}</div>
            <div class="history-meta">${d.timeIn} → ${d.timeOut} • ${hours} giờ • ${(hours*14000).toLocaleString()} đ</div>
            ${d.paid ? '<div style="margin-top:6px;color:#2e7d32;font-weight:700">Đã thanh toán</div>' : ''}
          </div>
          <div class="history-actions">
            <div class="action-btn edit" title="Sửa"><i class="fas fa-edit"></i></div>
            <div class="action-btn delete" title="Xóa"><i class="fas fa-trash-alt"></i></div>
          </div>
        `;
        // attach events using closures
        wrapper.querySelector(".delete").addEventListener("click", ()=> deleteAddRecord(doc.id));
        wrapper.querySelector(".edit").addEventListener("click", ()=> editAddRecord(doc.id, d.date, d.timeIn, d.timeOut));
        el.appendChild(wrapper);
      });
    }, err => {
      el.innerHTML = "<p style='color:#999'>Lỗi tải dữ liệu</p>";
      console.error(err);
    });
  }

  /* ========== ADD ATTENDANCE LIST (same as history but separate view) ========== */
  function loadAddAttendance(){
    const el = document.getElementById("add-attendance-list");
    el.innerHTML = "Đang tải...";
    db.collection("attendance").orderBy("date","desc").onSnapshot(snapshot=>{
      el.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        if(d.email !== PHUC_EMAIL) return;
        const hours = calcHours(d.timeIn, d.timeOut);
        const wrapper = document.createElement("div");
        wrapper.className = "history-item" + (d.paid ? " paid" : "");
        wrapper.innerHTML = `
          <div class="history-left">
            <div style="font-weight:700">${d.date.replace(/-/g,'/')}</div>
            <div class="history-meta">${d.timeIn} → ${d.timeOut} • ${hours} giờ • ${(hours*14000).toLocaleString()} đ</div>
            ${d.paid ? '<div style="margin-top:6px;color:#2e7d32;font-weight:700">Đã thanh toán</div>' : ''}
          </div>
          <div class="history-actions">
            <div class="action-btn edit" title="Sửa"><i class="fas fa-edit"></i></div>
            <div class="action-btn delete" title="Xóa"><i class="fas fa-trash-alt"></i></div>
          </div>
        `;
        wrapper.querySelector(".delete").addEventListener("click", ()=> deleteAddRecord(doc.id));
        wrapper.querySelector(".edit").addEventListener("click", ()=> editAddRecord(doc.id, d.date, d.timeIn, d.timeOut));
        el.appendChild(wrapper);
      });
    }, err => { el.innerHTML = "<p style='color:#999'>Lỗi tải dữ liệu</p>"; console.error(err); });
  }

  /* ========== PAY LIST (checkboxes, unpaid on top) ========== */
  const payListEl = document.getElementById("pay-list");
  const totalBtn = document.getElementById("total-pay-btn");
  const selectAllBtn = document.getElementById("select-all-btn");
  const payNowBtn = document.getElementById("pay-now-btn");
  const markPaidBtn = document.getElementById("mark-paid-btn");

  // render function builds unpaid first then paid
  function renderPayList(snapshotAttendance, snapshotExtras){
    // collect docs
    const attDocs = [];
    snapshotAttendance.forEach(doc=>attDocs.push({id:doc.id, data:doc.data()}));
    const extraDocs = [];
    (snapshotExtras||[]).forEach(doc=>extraDocs.push({id:doc.id, data:doc.data()}));

    // filter only PHUC_EMAIL
    const attFiltered = attDocs.filter(x=>x.data.email===PHUC_EMAIL);
    const extraFiltered = extraDocs.filter(x=>x.data.email===PHUC_EMAIL);

    // separate unpaid / paid
    const attUnpaid = attFiltered.filter(x=>!x.data.paid);
    const attPaid = attFiltered.filter(x=>x.data.paid);
    const extraUnpaid = extraFiltered.filter(x=>!x.data.paid);
    const extraPaid = extraFiltered.filter(x=>x.data.paid);

    // clear
    payListEl.innerHTML = "";

    // function to create item row
    const makeRow = (item, type) => {
      const d = item.data;
      const id = item.id;
      const row = document.createElement("div");
      row.className = "pay-item" + (d.paid ? " paid" : "");
      // checkbox disabled & checked if paid
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "pay-check";
      chk.dataset.id = id;
      chk.dataset.type = type;
      if(d.paid){ chk.checked = true; chk.disabled = true; }
      // meta
      const meta = document.createElement("div");
      meta.className = "meta";
      if(type==="att"){
        const hours = ((new Date("2000/01/01 "+d.timeOut) - new Date("2000/01/01 "+d.timeIn))/3600000).toFixed(2);
        meta.innerHTML = `<strong>${d.date}</strong> → ${hours} giờ → <b>${(hours*14000).toLocaleString()} đ</b>` + (d.paid?` <span style="color:#2e7d32;font-weight:700;margin-left:8px">Đã thanh toán</span>`:'');
      } else {
        meta.innerHTML = `<strong>${d.type}</strong> → <b style="color:${d.amount<0?'#e11d48':'#16a34a'}">${Number(d.amount).toLocaleString()} đ</b>` + (d.paid?` <span style="color:#2e7d32;font-weight:700;margin-left:8px">Đã thanh toán</span>`:'');
      }
      row.appendChild(chk);
      row.appendChild(meta);
      // return row
      return row;
    };

    // append unpaid items first: attendance unpaid, extras unpaid
    attUnpaid.forEach(it=> payListEl.appendChild(makeRow(it, "att")));
    extraUnpaid.forEach(it=> payListEl.appendChild(makeRow(it, "extra")));
    // then paid items
    attPaid.forEach(it=> payListEl.appendChild(makeRow(it, "att")));
    extraPaid.forEach(it=> payListEl.appendChild(makeRow(it, "extra")));
  }

  // live snapshots and rendering
  let lastAttSnapshot = null;
  let lastExtraSnapshot = null;
  db.collection("attendance").orderBy("date","desc").onSnapshot(attSnap => {
    lastAttSnapshot = attSnap;
    // get extras once to combine
    db.collection("extras").orderBy("timestamp","desc").get().then(extraSnap => {
      lastExtraSnapshot = extraSnap;
      renderPayList(attSnap, extraSnap);
      updateTotalFromChecked(); // update total after render
      attachCheckListeners(); // attach events to newly rendered checkboxes
    });
  });

  // helper attach listeners to pay-checks
  function attachCheckListeners(){
    // delegate: add change listener to each checkbox
    document.querySelectorAll(".pay-check").forEach(chk => {
      // remove previous to avoid double
      chk.onchange = null;
      chk.addEventListener("change", ()=> updateTotalFromChecked());
    });
  }

  // compute sum of checked (only enabled checked)
  function updateTotalFromChecked(){
    const chks = Array.from(document.querySelectorAll(".pay-check:checked")).filter(c=>!c.disabled);
    let sum = 0;
    chks.forEach(c=>{
      const id = c.dataset.id;
      const type = c.dataset.type;
      if(type==="att"){
        // find in lastAttSnapshot
        if(!lastAttSnapshot) return;
        const doc = lastAttSnapshot.docs.find(x=>x.id===id);
        if(!doc) return;
        const d = doc.data();
        const hours = ((new Date("2000/01/01 "+d.timeOut) - new Date("2000/01/01 "+d.timeIn))/3600000);
        sum += hours * 14000;
      } else {
        if(!lastExtraSnapshot) return;
        const doc = lastExtraSnapshot.docs.find(x=>x.id===id);
        if(!doc) return;
        const d = doc.data();
        sum += Number(d.amount);
      }
    });
    totalBtn.innerText = `Tổng: ${Math.round(sum).toLocaleString()} đ`;
  }

  // select-all (only not-disabled)
  selectAllBtn.addEventListener("click", ()=>{
    document.querySelectorAll(".pay-check:not(:disabled)").forEach(c=> c.checked = true);
    updateTotalFromChecked();
  });

  // attach dynamic action for Pay Now (open QR popup)
  const qrPopup = document.getElementById("qr-popup");
  const qrBackdrop = document.getElementById("qr-backdrop");
  const qrClose = document.getElementById("qr-close");
  const qrCancel = document.getElementById("qr-cancel");
  const qrConfirm = document.getElementById("qr-confirm");
  const qrCount = document.getElementById("qr-count");
  const qrImage = document.getElementById("qr-image");

  // default placeholder — Phúc sẽ đổi bằng link Google Drive sau
  qrImage.src = 'qr.JPG';

  payNowBtn.addEventListener("click", ()=>{
    // count selected (enabled)
    const selected = Array.from(document.querySelectorAll(".pay-check:checked")).filter(c=>!c.disabled);
    if(selected.length === 0){ alert("Chọn ít nhất 1 khoản để thanh toán!"); return; }
    qrCount.innerText = selected.length;
    // show popup
    qrPopup.classList.add("active");
  });

  qrBackdrop.addEventListener("click", ()=> { qrPopup.classList.remove("active"); });
  qrClose.addEventListener("click", ()=> { qrPopup.classList.remove("active"); });
  qrCancel.addEventListener("click", ()=> { qrPopup.classList.remove("active"); });

  // On confirm: mark selected items paid && attach placeholder paymentImage
  qrConfirm.addEventListener("click", async ()=>{
    const selected = Array.from(document.querySelectorAll(".pay-check:checked")).filter(c=>!c.disabled);
    if(selected.length === 0){ alert("Không có khoản nào đang được chọn."); return; }
    if(!confirm(`Xác nhận đã chuyển khoản cho ${selected.length} khoản?`)) return;
    // placeholder QR image URL (you will replace later)
    const paymentImageURL = "https://via.placeholder.com/600x400.png?text=Payment+Proof";
    for(const c of selected){
      const coll = c.dataset.type === "att" ? "attendance" : "extras";
      await db.collection(coll).doc(c.dataset.id).update({ paid: true, paymentImage: paymentImageURL, paidAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
    alert("Đã ghi nhận thanh toán (đã đặt placeholder image).");
    qrPopup.classList.remove("active");
    // refresh lists
    loadHistory(); loadAddAttendance(); loadAllPayRefresh();
  });

  // mark-paid button: directly mark checked items as paid (no popup) — keeps previous behavior
  markPaidBtn.addEventListener("click", async ()=>{
    const selected = Array.from(document.querySelectorAll(".pay-check:checked")).filter(c=>!c.disabled);
    if(selected.length === 0){ alert("Chọn ít nhất 1 khoản!"); return; }
    if(!confirm(`Đánh dấu đã thanh toán cho ${selected.length} khoản?`)) return;
    for(const c of selected){
      const coll = c.dataset.type === "att" ? "attendance" : "extras";
      await db.collection(coll).doc(c.dataset.id).update({ paid:true, paidAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
    alert("Đã đánh dấu đã thanh toán !");
    loadHistory(); loadAddAttendance(); loadAllPayRefresh();
  });

  // helper to refresh pay snapshots render
  function loadAllPayRefresh(){
    // re-triggering snapshots will update automatically; but call updateTotalFromChecked and attach listeners
    setTimeout(()=>{ updateTotalFromChecked(); attachCheckListeners(); }, 600);
  }

  /* ========== Extras - minimal (kept for compatibility) ========== */
  function loadExtrasSnapshot(){
    // not rendering extras UI separately here; used in combined render
    return db.collection("extras").orderBy("timestamp","desc").get();
  }

  /* ========== Combined snapshots initial load (attendance & extras) ========== */
  // Already set above attendance real-time; but we keep a periodic check for extras changes
  db.collection("extras").orderBy("timestamp","desc").onSnapshot(extraSnap=>{
    // on extras change re-render pay list: find latest attendance snapshot by querying once
    db.collection("attendance").orderBy("date","desc").get().then(attSnap=>{
      renderPayList(attSnap, extraSnap);
      attachCheckListeners();
      updateTotalFromChecked();
    });
  });

  /* convenience wrapper loaders */
  function loadAllData(){ loadHistory(); loadAddAttendance(); /* pay list snapshots already active */ }

  /* utility initial call */
  loadAllData();

}); // DOMContentLoaded
</script>
</body>
</html>
