<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ch·∫•m c√¥ng ‚Äì Ch√∫ g·∫•u</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root {--primary:#66a6ff;--gradient:linear-gradient(135deg,#89f7fe,#66a6ff);--card:rgba(255,255,255,0.95);--shadow:0 10px 30px rgba(0,0,0,0.15);}
body{margin:0;padding:0;background:var(--gradient);font-family:'Kanit',sans-serif;color:#333;background-attachment:fixed;overflow-x:hidden;}
.menu-btn{position:fixed;top:20px;left:20px;z-index:1000;background:white;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;box-shadow:0 4px 15px rgba(0,0,0,0.2);cursor:pointer;}
.sidebar{position:fixed;top:0;left:-300px;width:280px;height:100vh;background:rgba(102,166,255,0.98);padding:80px 20px 20px;transition:left .4s;z-index:999;box-shadow:5px 0 20px rgba(0,0,0,0.2);}
.sidebar.active{left:0;}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);opacity:0;visibility:hidden;transition:.3s;z-index:998;}
.overlay.active{opacity:1;visibility:visible;}
.menu-item{padding:18px 20px;color:white;font-size:1.2rem;border-radius:12px;margin-bottom:10px;cursor:pointer;transition:.3s;}
.menu-item:hover,.menu-item.active{background:rgba(255,255,255,0.3);transform:translateX(10px);}
.menu-item i{margin-right:12px;}
.main-content{padding:20px;max-width:560px;margin:0 auto;min-height:100vh;}
.card{background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:30px;margin-top:80px;}
.hidden{display:none;}
.salary-summary{background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:20px;border-radius:16px;text-align:center;margin:20px 0;font-size:1.3rem;color:var(--primary);}
.history-item{position:relative;background:#f8fbff;padding:16px 50px 16px 16px;border-radius:14px;margin-bottom:12px;border-left:6px solid var(--primary);transition:all 0.3s;}
.history-item.today{border-left-color:#4caf50;background:#f0fff4;}
.history-item:hover{transform:translateX(6px);box-shadow:0 6px 20px rgba(0,0,0,0.12);}
.hours{color:#4caf50;font-weight:bold;}
.salary{color:#e91e63;font-weight:bold;}

/* N√∫t S·ª≠a & X√≥a ‚Äì ƒë·∫πp m∆∞·ª£t, di chuy·ªÉn c√πng √¥ */
.history-actions{
  position:absolute;top:12px;right:10px;opacity:0;transform:translateX(10px);transition:all 0.3s;
}
.history-item:hover .history-actions{opacity:1;transform:translateX(0);}
.action-btn{
  background:rgba(255,255,255,0.8);color:var(--primary);width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-left:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);cursor:pointer;transition:0.2s;
}
.action-btn:hover{transform:scale(1.15);background:white;}
.action-btn.edit{color:#ffb300;}
.action-btn.delete{color:#e91e63;}

input, button{width:100%;padding:14px;margin:10px 0;border-radius:12px;border:2px solid #ddd;font-size:1rem;}
button{background:var(--primary);color:white;border:none;cursor:pointer;}
</style>
</head>
<body>

<div class="menu-btn" id="menuBtn">‚ò∞</div>
<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
  <div class="menu-item active" data-page="checkin"><i class="fas fa-calendar-check"></i> Ch·∫•m c√¥ng h√¥m nay</div>
  <div class="menu-item" data-page="history"><i class="fas fa-history"></i> L·ªãch s·ª≠ & B·∫£ng l∆∞∆°ng</div>
  <div class="menu-item" id="logoutBtn" style="margin-top:auto;background:rgba(255,0,0,0.3);"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</div>
</div>

<div class="main-content">
  <!-- Trang ch·∫•m c√¥ng -->
  <div id="checkin-page" class="card">
    <h1 style="text-align:center;color:var(--primary);">Ch·∫•m c√¥ng h√¥m nay</h1>
    <p style="text-align:center;">Xin ch√†o <strong id="user-email">...</strong>!</p>
    <label>Ng√†y</label><input type="date" id="date">
    <label>Gi·ªù v√†o</label><input type="time" id="time-in">
    <label>Gi·ªù ra</label><input type="time" id="time-out">
    <button id="btn-save">L∆∞u ch·∫•m c√¥ng</button>
  </div>

  <!-- Trang l·ªãch s·ª≠ & l∆∞∆°ng -->
  <div id="history-page" class="card hidden">
    <h1 style="text-align:center;color:var(--primary);">L·ªãch s·ª≠ & B·∫£ng l∆∞∆°ng</h1>
    <div class="salary-summary">
      T·ªïng gi·ªù th√°ng n√†y: <span id="total-hours">0</span>h‚ÄÉ|‚ÄÉL∆∞∆°ng t·∫°m t√≠nh: <span id="total-salary">0</span> ƒë
    </div>
    <div id="history-list">ƒêang t·∫£i...</div>
  </div>
</div>

<script>
const firebaseConfig = {apiKey:"AIzaSyB3QQKW5kb9I3mZ4vr8lYcSBTEZZ1sAM8s",authDomain:"hplabs-jobs.firebaseapp.com",projectId:"hplabs-jobs",storageBucket:"hplabs-jobs.firebasestorage.app",messagingSenderId:"424963153110",appId:"1:424963153110:web:cb380d3dff8d5582dafd77",measurementId:"G-GGL0HW29KT"};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); 
const db = firebase.firestore();

// DOM
const menuBtn=document.getElementById("menuBtn"),sidebar=document.getElementById("sidebar"),overlay=document.getElementById("overlay");
const checkinPage=document.getElementById("checkin-page"),historyPage=document.getElementById("history-page");
const userEmail=document.getElementById("user-email");
const dateInput=document.getElementById("date"),timeIn=document.getElementById("time-in"),timeOut=document.getElementById("time-out");
const btnSave=document.getElementById("btn-save");
const historyList=document.getElementById("history-list");
const totalHoursEl=document.getElementById("total-hours"),totalSalaryEl=document.getElementById("total-salary");

// Menu
menuBtn.onclick=()=>{sidebar.classList.toggle("active");overlay.classList.toggle("active");};
overlay.onclick=()=>{sidebar.classList.remove("active");overlay.classList.remove("active");};
document.querySelectorAll(".menu-item").forEach(i=>{
  i.onclick=()=>{
    if(i.id==="logoutBtn"){auth.signOut();location.href="index.html";return;}
    document.querySelectorAll(".menu-item").forEach(x=>x.classList.remove("active")); i.classList.add("active");
    checkinPage.classList.add("hidden"); historyPage.classList.add("hidden");
    if(i.dataset.page==="checkin") checkinPage.classList.remove("hidden");
    if(i.dataset.page==="history"){historyPage.classList.remove("hidden");loadHistory();}
    sidebar.classList.remove("active");overlay.classList.remove("active");
  };
});

// Auth
auth.onAuthStateChanged(u=>{if(!u)location.href="index.html"; else userEmail.innerText=u.email;});
dateInput.valueAsDate=new Date();

// L∆∞u ch·∫•m c√¥ng
btnSave.onclick=async()=>{
  if(!dateInput.value||!timeIn.value||!timeOut.value){alert("ƒêi·ªÅn ƒë·∫ßy ƒë·ªß nh√©!");return;}
  await db.collection("attendance").add({
    uid: auth.currentUser.uid,
    email: auth.currentUser.email,
    date: dateInput.value,
    timeIn: timeIn.value,
    timeOut: timeOut.value,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Ch·∫•m c√¥ng th√†nh c√¥ng! üêª");
  timeIn.value=timeOut.value="";
  loadHistory();
};

// T√≠nh gi·ªù
function calcHours(inT,outT){
  let [h1,m1]=inT.split(":").map(Number);
  let [h2,m2]=outT.split(":").map(Number);
  let min = (h2*60+m2)-(h1*60+m1);
  if(min<0) min+=1440;
  return (min/60).toFixed(2);
}

// Load l·ªãch s·ª≠ + th√™m n√∫t S·ª≠a/X√≥a ƒë·∫πp m∆∞·ª£t
function loadHistory(){
  historyList.innerHTML = "ƒêang t·∫£i d·ªØ li·ªáu...";


  db.collection("attendance")
    .orderBy("date","desc")
    .onSnapshot(snap => {
      historyList.innerHTML = "";
        let totalH = 0;
      if(snap.empty){
        historyList.innerHTML = "<p style='text-align:center;color:#999;padding:30px;'>Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</p>";
        totalHoursEl.innerText = "0"; totalSalaryEl.innerText = "0";
        return;
      }

      const today = new Date().toISOString().slice(0,10);

      snap.forEach(doc => {
        const d = doc.data();
        if(d.email !== auth.currentUser.email) return;

        const hours = parseFloat(calcHours(d.timeIn, d.timeOut));
        totalH += hours;

        const div = document.createElement("div");
        div.className = "history-item" + (d.date===today?" today":"");

        div.innerHTML = `
          <strong>${d.date.replace(/-/g,"/")}</strong><br>
          ${d.timeIn} ‚Üí ${d.timeOut} <span class="hours">‚Üí ${hours} gi·ªù</span><br>
          <span class="salary">L∆∞∆°ng ng√†y: ${(hours*14000).toLocaleString()} ƒë</span>

          <div class="history-actions">
            <div class="action-btn edit" onclick="editRecord('${doc.id}', '${d.date}', '${d.timeIn}', '${d.timeOut}')">
              <i class="fas fa-edit"></i>
            </div>
            <div class="action-btn delete" onclick="deleteRecord('${doc.id}')">
              <i class="fas fa-trash-alt"></i>
            </div>
          </div>
        `;
        historyList.appendChild(div);
      });

      totalHoursEl.innerText = totalH.toFixed(2);
      totalSalaryEl.innerText = (totalH*14000).toLocaleString();
    });
}

// S·ª≠a b·∫£n ghi
function editRecord(id, date, timeInVal, timeOutVal){
  if(confirm("S·ª≠a b·∫£n ghi n√†y?")){
    dateInput.value = date;
    timeIn.value = timeInVal;
    timeOut.value = timeOutVal;
    db.collection("attendance").doc(id).delete().then(()=>{
      alert("ƒê√£ x√≥a c≈©! Gi·ªù b·∫°n ch·ªâ c·∫ßn nh·∫•n L∆∞u ƒë·ªÉ t·∫°o b·∫£n m·ªõi nh√© üêª");
      document.querySelector('.menu-item[data-page="checkin"]').click();
    });
  }
}

// X√≥a b·∫£n ghi
function deleteRecord(id){
  if(confirm("X√≥a vƒ©nh vi·ªÖn b·∫£n ghi n√†y?")){
    db.collection("attendance").doc(id).delete().then(()=>{
      alert("ƒê√£ x√≥a th√†nh c√¥ng!");
    });
  }
}
</script>
</body>
</html>